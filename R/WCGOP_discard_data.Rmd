---
title: "Explore discard data"
author: "Alaia"
date: "2025-02-05"
output: html_document
---
WCGOP data need to be downloaded in data_provided folder from google drive
# Install and load package
```{r}
library(ggplot2)
library(reshape2)
library(here)
library(dplyr)


```

# Visualizing the Data 
## Load and plot WCGOP data 

```{r}
data_discard_non_catch <- read.csv(here("data_provided/wcgop", "discard_rates_noncatch_share.csv")) %>%
  select(year, fleet, obs_discard) %>%
  rename(observed_discard_mt = obs_discard) %>%
  mutate(fleet = recode(fleet, 
         "bottomtrawl-coastwide" = "Bottom trawl",
         "hook-and-line-coastwide" = "Hook & Line"))

data_discard_catch<- read.csv(here("data_provided/wcgop", "discard_rates_combined_catch_share.csv")) %>%
  select("year", "fleet", "observed_discard_mt")%>%
  mutate(fleet = recode(fleet, 
         "bottomtrawl-coastwide" = "Bottom trawl",
         "hook-and-line-coastwide" = "Hook & Line",
         "midwaterrockfish-coastwide" = "Midwater trawl",
         "midwaterhake-coastwide" = "Midwater trawl"))

data_discard <- rbind(data_discard_non_catch, data_discard_catch)

ggplot(data_discard, aes(x = year, y = observed_discard_mt, fill = fleet)) +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  geom_col() +  
  theme_minimal() +
    labs(x = "Year", y = "Discards (mt)", 
       title = paste0("Discards (WCGOP)"))+
  theme(strip.text = element_text(face = "bold"))

```




## Discards length composition 
```{r}
data <- read.csv(here("data_provided/wcgop", "biological_discard_lengths.csv"))
data <- data[,-c(2,4,5,6,32:56)]
names(data) <- c("year", "fleet" , seq(8,56,2))
data <- melt(data, c("fleet", "year"))
data$variable = as.numeric(as.character(data$variable))

fleet_type <- unique(data$fleet)

ggplot(data[data$fleet==fleet_type[1],], aes(x = variable, y = value)) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Length bin (cm)", y = "%", 
       title = paste0("Discards by length bin by year for ",fleet_type[1])) +
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) 

ggplot(data[data$fleet==fleet_type[2],], aes(x = variable, y = value)) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Length bin (cm)", y = "%", 
       title = paste0("Discards by length bin by year for ",fleet_type[2]))+
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) 

ggplot(data[data$fleet==fleet_type[3],], aes(x = variable, y = value)) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Length bin (cm)", y = "%", 
       title = paste0("Discards by length bin by year for ",fleet_type[3])) +
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) 

ggplot(data[data$fleet==fleet_type[4],], aes(x = variable, y = value)) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Length bin (cm)", y = "%", 
       title = paste0("Discards by length bin by year for ",fleet_type[4]))+
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) 


# )
```

```{r}

# Bottom trawl
{plot(data[data$fleet==fleet_type[1],]$year, data[data$fleet==fleet_type[1],]$variable, xlab = "Year", ylab = "Length (cm)", main = "WCGOP discards by length by year (Bottom Trawl)",
     xlim = range(data[data$fleet==fleet_type[1],]$year), ylim = c(8, 62), type = "n")  
symbols(data[data$fleet==fleet_type[1],]$year, data[data$fleet==fleet_type[1],]$variable, circles = sqrt(data[data$fleet==fleet_type[1],]$value/pi), inches = 0.1, add = TRUE, bg = "white")

legend_x <- 2007
legend_y <- 60 
legend_sizes <- c(0.01, 0.4, 0.8) #Identical to 2019 updates
legend_circles <- sqrt(legend_sizes/pi)
symbols(legend_x-0.5 + (1:length(legend_sizes)) * 3,rep(legend_y+0.5, length(legend_sizes)) ,
        circles = legend_circles, inches = 0.1, add = TRUE, bg = "white")
text(legend_x + (1:length(legend_sizes)) * 3,rep(legend_y + 1, length(legend_sizes)) ,
     labels = legend_sizes, adj = 0)}



# Bottom trawl
{plot(data[data$fleet==fleet_type[2],]$year, data[data$fleet==fleet_type[2],]$variable, xlab = "Year", ylab = "Length (cm)", main = "WCGOP discards by length by year (hook and line)",
     xlim = range(data[data$fleet==fleet_type[2],]$year), ylim = c(8, 62), type = "n")  
symbols(data[data$fleet==fleet_type[2],]$year, data[data$fleet==fleet_type[2],]$variable, circles = sqrt(data[data$fleet==fleet_type[2],]$value/pi), inches = 0.1, add = TRUE, bg = "white")

legend_x <- 2007
legend_y <- 60 
legend_sizes <- c(0.01, 0.4, 0.8) #Identical to 2019 updates
legend_circles <- sqrt(legend_sizes/pi)
symbols(legend_x-0.5 + (1:length(legend_sizes)) * 3,rep(legend_y+0.5, length(legend_sizes)) ,
        circles = legend_circles, inches = 0.1, add = TRUE, bg = "white")
text(legend_x + (1:length(legend_sizes)) * 3,rep(legend_y + 1, length(legend_sizes)) ,
     labels = legend_sizes, adj = 0)}

```

## Look at ALL WCGOP discard data, regardless of fleet 

```{r}
data_agg <- data %>%
  group_by(year, variable) %>%
  mutate(value = sum(value)) %>%
  distinct(year, variable, value)%>%
  group_by(year)%>%
  mutate(value = value  /sum(value)*100)

ggplot(data_agg, aes(x = variable, y = value)) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Length bin (cm)", y = "%", 
       title = paste0("WCGOP discards by length bin by year"))+
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) 
```


```{r}
# Size comp by year
dev.new(width=5, height=20, unit="in")
{plot(data_agg$year, data_agg$variable, xlab = "Year", ylab = "Length (cm)", main = "WCGOP discards by length by year",
     xlim = range(data_agg$year), ylim = c(8, 62), type = "n")  
symbols(data_agg$year, data_agg$variable, circles = sqrt(data_agg$value/pi), inches = 0.1, add = TRUE, bg = "white")


# Legend

legend_x <- 2007
legend_y <- 60 
legend_sizes <- c(0.01, 0.4, 0.8) #Identical to 2019 updates
legend_circles <- sqrt(legend_sizes/pi)
symbols(legend_x-0.5 + (1:length(legend_sizes)) * 3,rep(legend_y+0.5, length(legend_sizes)) ,
        circles = legend_circles, inches = 0.1, add = TRUE, bg = "white")
text(legend_x + (1:length(legend_sizes)) * 3,rep(legend_y + 1, length(legend_sizes)) ,
     labels = legend_sizes, adj = 0)}
```

### Prepare length composition data for .dat file 

**Column order:** yr month fleet sex part Nsamp datavector(female-male)

Year = from 1985 - 2023. Data prior to WCGOP will not change (use the same as 2019 update assessment). Data beginning 2004 

Fleet codes: 
- 1 = BottomTrawl <--- length data used in 2019 
- 2 = MidwaterTrawl <-- 2025 WCGOP also has this length comp data? 
- 3 = Hake <-- 2025 WCGOP also has this length comp data? 
- 5 = HnL <--- length data used in 2010 
Sex codes: 
 - 0 = combined <-- all WCGOP data 
 - 1 = use female only
 - 2 = use male only
 - 3 = use both as joint sexxlength distribution
Partition codes  
 - 0 = combined
 - 1 = discard
 - 2 = retained

25 #_N_LengthBins; then enter lower edge of each length bin
8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40 42 44 46 48 50 52 54 56


### Grab length comps from 1980's from the 2019 .dat file! 

```{r}
library(remotes)
library(r4ss)

#ls("package:nwfscDiscard")
ssdat.2019 <- SS_readdat(file = "../data_provided/2019_assessment/2019widow.dat")

# # Discard biomass 
# ssdat.2019$discard_fleet_info #fleets = 1 (bottom trawl), 2 (midwater trawl), 5 (hook & line) 
# ssdat.2019$discard_data #biomass 

# Discard length comps 
length.comps.1980s <- ssdat.2019$lencomp %>% filter(part==1) %>% filter(year<2004 & year>0) #remove negative years


# FIGURE OUT 
# 2019 update assessment .dat file only has Botton Trawl and Hook & Line, but the 2025 WCGOP has hake and rockfish midwater trawl data!  
ssdat.2019$lencomp %>% filter(part==1) %>% filter(year>2004) %>% select(fleet) %>% distinct()

```


Read in sample and length comps data from WCGOP, 2025 version 

Here are discard samples & aggregation summary info 

```{r}
length.n <- read.csv(here("data_provided/wcgop", "../wcgop/biological_sample_sizes_length.csv"))
length.n %>% 
  ggplot(aes(x=gear_groups,y=fish)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, size=2) + 
  ggtitle("Number of fish for length comp data by fleet")
```


```{r}
length.comps.wcgop <- read.csv(here("data_provided/wcgop", "../wcgop/biological_discard_lengths.csv"), col.names = names(length.comps.1980s)) %>% #use same names as .dat from 2019 for easy row binding
  mutate(month=7) %>% 
  mutate(fleet=case_when(
    fleet=="bottomtrawl-coastwide"~1,
    fleet=="midwaterrockfish-coastwide"~2,
    fleet=="midwaterhake-coastwide"~3,
    fleet=="hook-and-line-coastwide"~5,
  ))

length.comps <- bind_rows(length.comps.1980s, length.comps.wcgop)

# Assuming we don't need to aggregate fleets further or remove hake & rockfish midwater trawls ... this file is what we will use for discard lengths in new model 
write_csv(length.comps, file = here("data_derived/discard_length_comps.csv"))
```


```{r}
# # Code not working 
# Visualize combined discard length comps.
# 
# test <- length.comps %>% 
#   pivot_longer(cols = f8:m56, names_to = "variable", values_to = "percent") %>%
#   mutate(count=Nsamp*percent/100) %>% 
#   mutate(keep=case_when(
#     year%in%c(1985,1986,1987)~"yes",
#     (sex==0 & grepl("f",variable))~"yes",
#     (sex==0 & grepl("m",variable))~"no")) %>% 
#   filter(keep=="yes") %>% 
# #  select(fleet, year, sex, variable, value) %>% 
#   group_by(year,variable,sex) %>%
#   mutate(value = sum(count)) %>%
#   distinct(year, sex, variable, value) #%>%
# #  group_by(year)%>%
# #  mutate(value = value  /sum(value)*100)
# 
# 
# dev.new(width=5, height=20, unit="in")
# {plot(test$year, test$variable, col=test$sex, xlab = "Year", ylab = "Length (cm)", main = "Discards by length by year",
#      xlim = range(test$year), ylim = c(8, 62), type = "n")  
# symbols(test$year, test$variable, circles = sqrt(test$value/pi), inches = 0.1, add = TRUE, bg = "white")
# 
# 
# # Legend
# legend_x <- 2007
# legend_y <- 60 
# legend_sizes <- c(0.01, 0.4, 0.8) #Identical to 2019 updates
# legend_circles <- sqrt(legend_sizes/pi)
# symbols(legend_x-0.5 + (1:length(legend_sizes)) * 3,rep(legend_y+0.5, length(legend_sizes)) ,
#         circles = legend_circles, inches = 0.1, add = TRUE, bg = "white")
# text(legend_x + (1:length(legend_sizes)) * 3,rep(legend_y + 1, length(legend_sizes)) ,
#      labels = legend_sizes, adj = 0)}

```



